# VPN Monitor Service

Сервис для мониторинга подключения Cisco VPN AnyConnect и отправки уведомлений в Telegram.

## Возможности

- ✅ Автоматическая проверка статуса VPN соединения
- ✅ Уведомления в Telegram при изменении статуса (подключено/отключено)
- ✅ Работа как Windows Service (фоновый режим)
- ✅ Несколько методов проверки VPN (CLI, сетевые адаптеры, процессы)
- ✅ Настраиваемый интервал проверки
- ✅ Логирование всех событий

## Требования

- Python 3.8+
- Cisco AnyConnect Secure Mobility Client (опционально)
- Telegram Bot Token
- Telegram Chat ID

## Установка

### 1. Установка зависимостей

```bash
pip install -r requirements.txt
```

### 2. Настройка Telegram бота

#### Создание бота:

1. Откройте Telegram и найдите [@BotFather](https://t.me/botfather)
2. Отправьте команду `/newbot`
3. Следуйте инструкциям для создания бота
4. Сохраните полученный токен

#### Получение Chat ID:

1. Найдите бота [@userinfobot](https://t.me/userinfobot) в Telegram
2. Запустите бота командой `/start`
3. Скопируйте ваш Chat ID

### 3. Настройка конфигурации

Создайте файл `.env` на основе `env.example`:

```bash
copy env.example .env
```

Отредактируйте `.env` файл и укажите:

```env
TELEGRAM_BOT_TOKEN=your_telegram_bot_token_here
TELEGRAM_CHAT_ID=your_telegram_chat_id_here
VPN_CHECK_INTERVAL=30  # Интервал проверки в секундах
```

### 4. Запуск

#### Ручной запуск (для тестирования):

```bash
python vpn_monitor.py
```

#### Установка как Windows Service:

1. Запустите PowerShell от имени администратора
2. Выполните скрипт установки:

```powershell
.\install_vpn_service.ps1
```

Скрипт автоматически:
- Установит зависимости
- Установит NSSM (если необходимо)
- Создаст Windows Service
- Запустит сервис

### 5. Управление сервисом

```powershell
# Запуск
Start-Service -Name VPNMonitorService

# Остановка
Stop-Service -Name VPNMonitorService

# Перезапуск
Restart-Service -Name VPNMonitorService

# Статус
Get-Service -Name VPNMonitorService

# Просмотр логов
Get-Content vpn_monitor.log -Tail 50
```

## Конфигурация

### Переменные окружения

| Переменная | Описание | Обязательная |
|------------|----------|--------------|
| `TELEGRAM_BOT_TOKEN` | Токен Telegram бота | Да |
| `TELEGRAM_CHAT_ID` | Chat ID для отправки сообщений | Да |
| `VPN_CHECK_INTERVAL` | Интервал проверки в секундах (по умолчанию: 30) | Нет |
| `VPN_ADAPTER_NAME` | Имя VPN адаптера (по умолчанию: "Cisco AnyConnect") | Нет |

### Методы проверки VPN

Сервис использует несколько методов для определения статуса VPN:

1. **VPN CLI** (если установлен Cisco AnyConnect)
   - Проверка через `vpncli.exe state`
   - Наиболее точный метод

2. **Сетевые адаптеры**
   - Проверка активных сетевых адаптеров через PowerShell
   - Поиск адаптеров с именами "AnyConnect" или "Cisco"

3. **Процессы**
   - Проверка наличия процесса `vpnui.exe`
   - Дополнительная проверка

## Логирование

Сервис создает файлы логов:

- `vpn_monitor.log` - основной лог
- `vpn_monitor_service.log` - лог сервиса (при работе как Windows Service)
- `vpn_monitor_service.error.log` - лог ошибок сервиса

## Устранение неполадок

### Сервис не запускается

1. Проверьте права доступа (сервис должен запускаться от имени администратора)
2. Проверьте наличие `.env` файла с корректными настройками
3. Проверьте логи: `vpn_monitor_service.error.log`

### Не приходят уведомления в Telegram

1. Проверьте правильность `TELEGRAM_BOT_TOKEN`
2. Проверьте правильность `TELEGRAM_CHAT_ID`
3. Убедитесь, что бот запущен и доступен
4. Проверьте логи на наличие ошибок

### VPN не определяется

1. Убедитесь, что Cisco AnyConnect установлен
2. Проверьте имя VPN адаптера в настройках
3. Попробуйте изменить `VPN_ADAPTER_NAME` в `.env`
4. Проверьте логи для диагностики

### Проблемы с правами доступа

Если сервис не может получить доступ к сетевому адаптеру:

1. Убедитесь, что сервис запущен от имени администратора
2. Проверьте настройки безопасности Windows
3. Проверьте политики групповых политик (если используется домен)

## Формат уведомлений

### Подключение VPN:
```
✅ VPN AnyConnect

Статус: ПОДКЛЮЧЕНО
Время: 2025-01-XX XX:XX:XX
```

### Отключение VPN:
```
❌ VPN AnyConnect

Статус: ОТКЛЮЧЕНО
Время: 2025-01-XX XX:XX:XX
```

## Разработка

### Структура проекта

```
vpn_monitor.py          # Основной скрипт мониторинга
install_vpn_service.ps1 # Скрипт установки Windows Service
env.example             # Пример конфигурации
requirements.txt        # Зависимости Python
```

### Добавление новых методов проверки

Для добавления нового метода проверки VPN:

1. Создайте новый метод в классе `VPNMonitor`
2. Добавьте вызов метода в `check_vpn_status()`
3. Обновите документацию

## Лицензия

Проект распространяется под лицензией MIT.

## Поддержка

При возникновении проблем создайте issue в репозитории проекта.

